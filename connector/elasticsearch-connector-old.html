<html>
<meta http-equiv="Cache-Control" content="no-store" />
<head>
  <title>Incremental Update Example</title>
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
  <script src="/jquery/jquery.min.js" type="text/javascript"></script>
  <script src="/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
  <script src="/lodash/lodash.js" type="text/javascript"></script>
  <script src="/resources/tableau.js" type="text/javascript"></script>
  <script type="text/javascript">
    (function() {
  var myConnector = tableau.makeConnector();
  
  var elasticsearchTableauDataTypeMap = {
    string: 'string',
    float: 'float',
    long: 'int',
    int: 'int',
    date: 'date',
    boolean: 'bool'
  },
    elasticsearchFields = [];

 // myConnector.init = function () {
    // Set the name of the column that should be used for incremental updates
    // tableau.incrementalExtractColumn = '_sequence';
  //  tableau.log('[init] called');
  //  tableau.initCallback();
 // }

  myConnector.getColumnHeaders = function ()
  {
      tableau.log('[getColumnHeaders] called');
    
    var connectionData = JSON.parse(tableau.connectionData);
    
    elasticsearchFields.push({ name: '_id', dataType: 'string' });
    elasticsearchFields.push({ name: '_sequence', dataType: 'int' });
    
    $.ajax(connectionData.elasticsearchUrl + '/' + connectionData.elasticsearchIndex + '/' + connectionData.elasticsearchType + '/_mapping', {
      dataType: 'json',
      success: function(data){
                
        _.forIn(data[connectionData.elasticsearchIndex].mappings[connectionData.elasticsearchType].properties, function(val, key){
          // console.log('Iterating on key: ' + key + ', type: ' + elasticsearchTableauDataTypeMap[val.type]);
          if(_.isUndefined(elasticsearchTableauDataTypeMap[val.type])){
            return;
          }
          
          var field = {
            name: key,
            dataType: elasticsearchTableauDataTypeMap[val.type] 
          };
         // console.log('Pushing: ', field);
          elasticsearchFields.push(field);
          
            // console.log('Field names: ', _.pluck(elasticsearchFields, 'name'));
            tableau.headersCallback(_.pluck(elasticsearchFields, 'name'), _.pluck(elasticsearchFields, 'dataType'));
    
        });
        
      },
      error: function(xhr, ajaxOptions, err){
          tableau.log("connection error: " + xhr.responseText + "\n" + thrownError);
          tableau.abortWithError("error connecting to the Elasticsearch cluster for mapping");
      }
    });   

  }


  //With this sample we will generate some sample date for the columns: id, x, day, date_and _time, true_or_false, and color.
  //The user input for the max iterations determines the number of rows to add. 
  // 
  myConnector.getTableData = function (lastRecordNumber) {
    if(isShutdown){
      console.log('Shutdown already happened');
      return;
    }
    
    var lastId = parseInt(lastRecordNumber || -1);

    var connectionData = JSON.parse(tableau.connectionData);
    var max_iterations = connectionData.max_iterations; 
       
    var requestData = {
      query: {match_all: {} },
      from: lastId + 1,
      size: max_iterations
    };
    
    tableau.log('Elasticsearch search request: ', requestData);
    console.log('Elasticsearch search request: ', requestData);
  
  /*
    $.ajax(connectionData.elasticsearchUrl + '/' + connectionData.elasticsearchIndex + '/' + 
           connectionData.elasticsearchType + '/_search', {
      method: 'POST',
      data: JSON.stringify(requestData),
      processData: false,
      dataType: 'json',
      success: function(res){
      var i = requestData.from;
        
        data = [];
        _.each(res.hits.hits, function(hit){
          
          var item = hit._source;
          item._id = hit._id;
          item._sequence = i;
          
          // console.log('Pushing item: ', item);
          
          data.push(item);
          i++;
        });
        
        // tableau.dataCallback(data, '' + i, ((i + 1) < res.hits.total));
        tableau.dataCallback(data, data.length.toString(), false);
      },
      error: function(xhr, ajaxOptions, err){
          tableau.log("connection error: " + xhr.responseText + "\n" + thrownError);
          tableau.abortWithError("error connecting to the Elasticsearch cluster");
      }
    });
    */
    

    var colors = ["red", "orange", "yellow", "green", "blue", "indigo", "violet"];
    var data = [];
    var now = Date();
    date_and_time = new Date();                
	for (var i = 0; i < max_iterations; i++) {
		lastId ++;
		var id = lastId;
		var millis = date_and_time.getTime();
        millis += 1000 * i;    //add a second
		date_and_time.setTime(millis);
		date_only = new Date(date_and_time.getTime());                            
		date_only.setHours(0, 0, 0, 0);
		data.push({
			"_id": id,
			"x": i,
			"day": date_only.toISOString(),
			"day_and_time" : date_and_time.toISOString(),
			"true_or_false" : i % 2,
			"color" : colors[id % colors.length],
		});
	}

    tableau.dataCallback(data, lastId.toString(), false);
 
  };
  
  var isShutdown = false;
 
  myConnector.shutdown = function(){
    isShutdown = true;
    
    tableau.shutdownCallback();
  };

  tableau.registerConnector(myConnector);
})();

$(document).ready(function () {
  $("#inputForm").submit(function(evt) { // This event fires when a button is clicked
    evt.preventDefault();
    
    tableau.log('Submit called');
    
    var max_iterations = $('#inputMaxIterations').val();
    var esUrl = $('#inputElasticsearchUrl').val();
    var esIndex = $('#inputElasticsearchIndex').val();
    var esType = $('#inputElasticsearchType').val();
    
    var connectionData = { 
      max_iterations : parseInt(max_iterations),
      elasticsearchUrl: esUrl,
      elasticsearchIndex: esIndex,
      elasticsearchType: esType 
    };
    
    tableau.connectionData = JSON.stringify(connectionData);
    tableau.connectionName = "Elasticsearch " + esUrl + '/' + esIndex + '/' + esType;
    tableau.submit();
  });
});

  </script>
</head>

<body>



  <div class="container-fluid">
    <div class="row">
      <div class="col-md-10 col-md-offset-1">

        <h2>Elasticsearch Tableau Web Data Connector</h2>

        <img src="../resources/elasticsearch.png" class="img-responsive" alt="Responsive image">

        <form id="inputForm">
          <div class="form-group">
            <label for="inputElasticsearchUrl">Elasticsearch URL</label>
            <input class="form-control" id="inputElasticsearchUrl" placeholder="Elasticsearch URL" val="http://usadcpdm63.tnd.us.cbre.net:9200">
          </div>
          <div class="form-group">
            <label for="inputElasticsearchIndex">Index Name</label>
            <input class="form-control" id="inputElasticsearchIndex" placeholder="Name of index like 'index1'" val="rpdw">
          </div>
          <div class="form-group">
            <label for="inputElasticsearchType">Type</label>
            <input class="form-control" id="inputElasticsearchType" placeholder="Name of type like 'user'" val="property">
          </div>
          <div class="form-group">
            <label for="inputMaxIterations">Number of rows to add on every refresh</label>
            <input type="number" class="form-control" id="inputMaxIterations" valye="2" placeholder="Number of rows">
          </div>
          <button type="submit" class="btn btn-default">Submit</button>
        </form>
      </div>

    </div>
    <div class="row">
      <div class="col-md-10 col-md-offset-1">
        <div class="alert alert-success">
        <p>To add more rows of data you will need to:</p>
        <ul>
          <li>Select Tableau's data menu
            <li>Select your data source name
              <li>Then select incremental refresh from extract menu.
        </ul>
        </div>
      </div>
    </div>
  </div>

</body>

</html>